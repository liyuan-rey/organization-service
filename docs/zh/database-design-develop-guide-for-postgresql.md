# PostgreSQL 数据库设计和开发指南

本文档旨在为 organization-service 项目的数据库设计提供统一的规范和最佳实践指导，确保数据库设计的一致性、可维护性和高性能。

## 1. 设计原则

### 1.1 范式要求

在数据库设计中，应遵循关系数据库理论，达到较高的范式匹配（3NF），以避免数据冗余并明确数据间的关系。这有助于确保数据的一致性和完整性。

在特定场景下，如果性能要求或业务便利性收益高于数据管理影响，可以适当突破范式要求，但需要经过充分评估。

### 1.2 字符集和编码规范

应当采用 `Unicode` 字符集和 `UTF8` 编码，这是 PostgreSQL 数据库的默认设置。此规范确保了对多语言字符的良好支持，包括中文、日文、韩文等。

对于仅使用中文的场景，可以考虑使用 `GB18030` 字符集和编码，但不建议使用 `GB2312` 或 `GBK`。

### 1.3 表结构设计原则

1. 所有表必须有主键，用于唯一标识表中的每一行记录。

2. 对于关联两个表的字段，一般应该分别建立主键、外键。是否建立外键约束需要根据数据完整性和性能要求决定：
   - 不建议为引用的字典表字段建立外键约束，因为字典表常常被多个表引用，外键检查可能引起锁等待和死锁问题。
   - 当表有4个以上外键约束时，应特别注意是否确有必要，可考虑转为逻辑外键而非外键约束。
   - 当表被其他4个以上表引用为外键关联表时，需特别注意外键检查锁等待可能造成的死锁问题。

3. 有唯一性要求的字段必须建立唯一性约束，以确保数据的唯一性。

4. 建议为主要业务表增加创建时间字段 `created_at` 和最后更新时间字段 `updated_at`，用于乐观锁机制和问题排查。

5. 所有表必须包含 `tenant_id` 字段，用于多租户数据隔离。

### 1.4 分区表使用指南

分区表适用于以下场景：

- 大于 2GB 的表
- 含有 1000 万条记录以上的表
- 将会含有大量数据的表
- 需要定期归档日志或删除部分数据的表

分区策略选择：

- 按字段值范围进行 Range 范围分区（适用于按时间增长的表）
- 按某个字段的几个关键值进行 List 列表分区
- 对于静态表，可采用 Hash 哈希分区或 List 列表分区

### 1.5 索引设计原则

1. 对于查询中需要作为查询条件的字段，应考虑建立索引。

2. 为了提高性能，建议对外键字段建立索引。

3. 对于复合索引，索引字段顺序比较关键，应将查询频率较高的字段排在索引组合的最前面。

4. 定期审查和移除未使用的索引，以减少存储开销和维护成本。

## 2. 命名规范

### 2.1 通用命名原则

所有数据库对象遵循如下命名原则：

1. 使用小写字母、数字和下划线组成，不使用大写字母和特殊字符。
2. 名称应具有描述性且无歧义，避免使用保留字或关键字。
3. 英文单词使用单数形式。
4. 命名长度应限制在 30 个字符内。
5. 当一个单词不能表达对象含义时，使用下划线连接多个单词。

### 2.2 表和字段命名规范

1. 表名应遵循特定前缀规范：
   - 业务数据表：`b_org_*`
   - 关系表：`r_org_*`
   - 字典表：`d_org_*`
   - 统计台账表：`s_org_*`
   - 临时表：`tmp_org_*`

2. 字段命名应语义清晰，采用下划线分隔的英文单词组合。

3. 主键字段通常命名为 `id`，引用其他表的外键字段采用 `<引用表名>_id` 的格式。

4. 时间字段使用 `created_at` 和 `updated_at` 命名。

### 2.3 约束命名规范

1. 主键约束：`pk_<表名>`
2. 外键约束：`fk_<表名>_<引用表名>`（如果有多个外键引用同一表，则为 `fk_<表名>_<引用表名>_<字段名>`）
3. 唯一性约束：`uk_<表名缩写>_<标识>`
4. NOT NULL 约束和 CHECK 约束由数据库自动生成名称。

### 2.4 索引命名规范

1. 普通索引：`idx_<表名缩写>_<字段名>`
2. 复合索引：`idx_<表名缩写>_<含义>`（含义可由多个字段组合而成）

## 3. 数据类型使用约定

在选择数据类型时，应根据实际业务需求和数据特点进行选择：

1. **字符类型**：
   - 固定长度的字符串使用 `CHAR(n)`
   - 长度不固定的字符串使用 `VARCHAR(n)`
   - 超过 1GB 的字符数据使用 `TEXT`

2. **数值类型**：
   - 优先使用 4 字节的 `INTEGER` 类型
   - 大数值使用 8 字节的 `BIGINT` 类型
   - 浮点数使用 `DOUBLE PRECISION`
   - 避免使用 `DECIMAL` 类型，除非有特殊精度要求

3. **日期和时间类型**：
   - 业务逻辑产生的时间使用 `TIMESTAMP WITH TIME ZONE`
   - 外部导入的时间数据可使用 `VARCHAR` 类型存储，格式为 `YYYYMMDDHH24MISS`

4. **布尔类型**：
   - 使用 PostgreSQL 的 `BOOLEAN` 类型

5. **特殊类型**：
   - UUID 可用作业务表主键，但字典表中尽量不使用
   - JSON 数据使用 `JSONB` 类型存储
   - 二进制数据使用 `BYTEA` 类型

## 4. 项目特定规范

### 4.1 主键生成策略

所有表的主键 ID 值使用 64 位雪花算法生成，而非 UUID。这种策略确保了主键的全局唯一性和趋势递增性，有利于数据库性能优化。

### 4.2 NULL值处理规范

为确保数据完整性和避免空值相关的计算问题，数据库中不允许出现 NULL 值。所有字段必须提供默认值：

- 时间类型字段默认值为：`2000-01-01 00:00:00`
- 字符串类型字段默认值为：空字符串 `""`
- 数值类型字段默认值为：`0`

### 4.3 必需字段要求

所有表必须包含以下字段：

- `id`：主键字段
- `created_at`：记录创建时间
- `updated_at`：记录最后更新时间，使用 Spring JPA 的内置乐观锁机制自动更新
- `tenant_id`：租户标识，用于多租户数据隔离

### 4.4 字典字段设计

1. 简单字典值应存储为字符类型，使用有意义的单字母标识。例如性别用 `CHAR(1)` 类型，取值 'M', 'F' 等。
2. 字典值的文本显示由前端处理，数据库中仅存储标识符。
3. 排序字段统一命名为 `sort`。

## 5. 开发规范

### 5.1 SQL编写规范

1. **字符类型数据**：SQL中的字符类型数据应该统一使用单引号。特别是纯数字的字符串，必须用单引号，否则会导致内部转换而引起性能问题或索引失效。

2. **INSERT语句**：使用INSERT语句时一定要给出插入值的字段列表，这样即使更改了表结构加了字段也不会影响现有系统的运行。

3. **SELECT语句**：避免使用`SELECT *`语句，应明确指定需要的字段列表，除非确实需要所有字段。

4. **WHERE条件**：无论是SELECT、UPDATE还是DELETE语句，都必须检查WHERE条件的完整性，避免数据丢失。不确定时应先用SELECT语句验证条件。

### 5.2 性能优化建议

1. **查询优化**：
   - 条件查询时，将高过滤性的属性字段放在条件的左边
   - 避免在大数据量表上使用IN子句，考虑使用连接查询替代
   - 避免不必要的排序操作

2. **索引优化**：
   - 为外键字段和经常用于查询条件的字段建立索引
   - 合理使用复合索引，将查询频率高的字段放在索引前列
   - 定期审查并删除未使用的索引

3. **复杂SQL**：
   - 对于非常复杂的SQL（特别是多层嵌套、子查询等），应先考虑是否设计不当引起的
   - 可以使用EXPLAIN ANALYZE分析查询性能

4. **连接池**：
   - 使用连接池管理数据库连接，提高连接复用率

---

遵循以上数据库设计最佳实践，有助于提升系统性能、可维护性和数据一致性。在实际开发过程中，应根据具体业务场景灵活应用这些原则，并在团队内部保持一致的规范。
